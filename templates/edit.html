<!DOCTYPE html>
<html lang="tr" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mevzuat Düzenle - Türk Mevzuat Çıkarıcı</title>
    <link href="https://cdn.replit.com/agent/bootstrap-agent-dark-theme.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .editable {
            border: 1px solid transparent;
            padding: 8px;
            border-radius: 4px;
            transition: all 0.3s ease;
        }
        .editable:hover {
            border-color: var(--bs-info);
            background-color: var(--bs-dark);
        }
        .editable:focus {
            border-color: var(--bs-primary);
            background-color: var(--bs-dark);
            outline: none;
        }
        .article-item {
            border: 1px solid var(--bs-border-color);
            border-radius: 8px;
            margin-bottom: 16px;
            transition: all 0.3s ease;
        }
        .article-item:hover {
            border-color: var(--bs-info);
        }
        .paragraph-item {
            border: 1px solid var(--bs-border-color-translucent);
            border-radius: 6px;
            margin-bottom: 8px;
            padding: 12px;
            transition: all 0.3s ease;
        }
        .paragraph-item:hover {
            border-color: var(--bs-info);
            background-color: var(--bs-body-bg);
        }
        .action-buttons {
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .article-item:hover .action-buttons,
        .paragraph-item:hover .action-buttons {
            opacity: 1;
        }
        .save-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1050;
        }
        .drag-handle {
            cursor: move;
            color: var(--bs-secondary);
        }
        .drag-handle:hover {
            color: var(--bs-primary);
        }
        .split-layout {
            display: flex;
            height: calc(100vh - 200px);
            gap: 16px;
        }
        .pdf-panel {
            flex: 0 0 50%;
            border: 1px solid var(--bs-border-color);
            border-radius: 8px;
            background: var(--bs-body-bg);
            display: none;
        }
        .pdf-panel.show {
            display: block;
        }
        .edit-panel {
            flex: 1;
            overflow-y: auto;
            max-height: calc(100vh - 200px);
        }
        .edit-panel.full-width {
            flex: 1 1 100%;
        }
        .pdf-viewer-container {
            height: 100%;
            position: relative;
        }
        .pdf-viewer-header {
            padding: 12px 16px;
            border-bottom: 1px solid var(--bs-border-color);
            background: var(--bs-body-secondary);
            border-radius: 8px 8px 0 0;
        }
        .pdf-iframe {
            width: 100%;
            height: calc(100% - 60px);
            border: none;
            border-radius: 0 0 8px 8px;
        }
        .no-pdf-message {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            flex-direction: column;
            color: var(--bs-text-muted);
        }
        .textLayer {
            position: absolute;
            left: 0;
            top: 0;
            right: 0;
            bottom: 0;
            overflow: hidden;
            opacity: 0.2;
            line-height: 1.0;
        }
        .textLayer > span {
            color: transparent;
            position: absolute;
            white-space: pre;
            cursor: text;
            transform-origin: 0% 0%;
        }
    </style>
</head>
<body>
    <div class="container-fluid mt-4">
        <!-- Save Indicator -->
        <div id="saveIndicator" class="save-indicator"></div>
        
        <!-- Header -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h1 class="card-title mb-0">
                    <i class="bi bi-pencil-square me-2"></i>
                    Mevzuat Düzenle
                </h1>
                <div>
                    <button id="saveBtn" class="btn btn-success me-2">
                        <i class="bi bi-save me-2"></i>
                        Kaydet
                    </button>

                    <a href="{{ url_for('download_file', filename=json_filename) }}" 
                       class="btn btn-primary me-2">
                        <i class="bi bi-download me-2"></i>
                        JSON İndir
                    </a>
                    <button id="backBtn" class="btn btn-secondary me-2">
                        <i class="bi bi-arrow-left me-2"></i>
                        Geri Dön
                    </button>
                    <a href="{{ url_for('index') }}" class="btn btn-outline-secondary">
                        <i class="bi bi-house me-2"></i>
                        Ana Sayfa
                    </a>
                </div>
            </div>
            <div class="card-body">
                <p class="text-muted mb-0">
                    <i class="bi bi-info-circle me-2"></i>
                    Metinlere tıklayarak düzenleyebilir, madde ve fıkra ekleyip silebilirsiniz.
                </p>
            </div>
        </div>


                <!-- Document Title -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-file-text me-2"></i>
                            Mevzuat Başlığı
                        </h5>
                    </div>
                    <div class="card-body">
                        <h4 class="text-primary editable" 
                            contenteditable="true" 
                            data-field="title"
                            id="documentTitle">{{ result.mevzuat_basligi }}</h4>
                    </div>
                </div>

                <!-- Articles -->
                <div class="card mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-list-ol me-2"></i>
                            Maddeler
                        </h5>
                        <button id="addArticleBtn" class="btn btn-outline-success btn-sm">
                            <i class="bi bi-plus-circle me-2"></i>
                            Yeni Madde Ekle
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="articlesContainer">
                            {% for madde in result.maddeler %}
                                <div class="article-item" data-article-index="{{ loop.index0 }}">
                                    <div class="card-header d-flex justify-content-between align-items-center">
                                        <div class="d-flex align-items-center">
                                            <i class="bi bi-grip-vertical drag-handle me-2"></i>
                                            <h6 class="mb-0 editable" 
                                                contenteditable="true" 
                                                data-field="article-title"
                                                data-article-index="{{ loop.index0 }}">{{ madde.madde_numarasi }}</h6>
                                        </div>
                                        <div class="action-buttons">
                                            <button class="btn btn-outline-primary btn-sm me-2 add-paragraph-btn" 
                                                    data-article-index="{{ loop.index0 }}">
                                                <i class="bi bi-plus me-1"></i>
                                                Fıkra Ekle
                                            </button>
                                            <button class="btn btn-outline-danger btn-sm delete-article-btn" 
                                                    data-article-index="{{ loop.index0 }}">
                                                <i class="bi bi-trash me-1"></i>
                                                Sil
                                            </button>
                                        </div>
                                    </div>
                                    <div class="card-body">
                                        <div class="paragraphs-container" data-article-index="{{ loop.index0 }}">
                                            {% for fikra in madde.fikralar %}
                                                <div class="paragraph-item" data-paragraph-index="{{ loop.index0 }}">
                                                    <div class="d-flex justify-content-between align-items-start">
                                                        <div class="flex-grow-1">
                                                            <i class="bi bi-grip-vertical drag-handle me-2"></i>
                                                            <span class="badge bg-info me-2">{{ loop.index }}</span>
                                                            <div class="editable d-inline-block" 
                                                                 contenteditable="true" 
                                                                 data-field="paragraph"
                                                                 data-article-index="{{ loop.index0 }}"
                                                                 data-paragraph-index="{{ loop.index0 }}"
                                                                 style="min-width: 200px;">{{ fikra }}</div>
                                                        </div>
                                                        <div class="action-buttons ms-2">
                                                            <button class="btn btn-outline-danger btn-sm delete-paragraph-btn" 
                                                                    data-article-index="{{ loop.index0 }}"
                                                                    data-paragraph-index="{{ loop.index0 }}">
                                                                <i class="bi bi-trash"></i>
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="deleteModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Silme Onayı</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p id="deleteMessage">Bu öğeyi silmek istediğinize emin misiniz?</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Sil</button>
                </div>
            </div>
        </div>
    </div>

    <!-- PDF Viewer Modal -->
    <div class="modal fade" id="pdfModal" tabindex="-1">
        <div class="modal-dialog modal-fullscreen">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-file-pdf me-2"></i>
                        Orijinal Dosya: <span id="pdfFileName"></span>
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-0">
                    <div id="pdfViewerContainer" style="height: calc(100vh - 120px);">
                        <iframe id="pdfViewer" 
                                width="100%" 
                                height="100%" 
                                frameborder="0"
                                style="border: none;">
                        </iframe>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle me-2"></i>
                        Kapat
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <!-- Data transfer -->
    <script type="application/json" id="documentData">{{ result | tojson_utf8 | safe }}</script>
    
    <script>
        // Document data
        let documentData = JSON.parse(document.getElementById('documentData').textContent);
        const jsonFilename = "{{ json_filename }}";
        
        // Elements
        const saveBtn = document.getElementById('saveBtn');
        const saveIndicator = document.getElementById('saveIndicator');
        const backBtn = document.getElementById('backBtn');
        const deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
        
        // Auto-save functionality
        let saveTimeout;
        let hasUnsavedChanges = false;
        
        function showSaveIndicator(message, type = 'success') {
            saveIndicator.innerHTML = `
                <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                    <i class="bi bi-${type === 'success' ? 'check-circle' : 'exclamation-triangle'} me-2"></i>
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            
            setTimeout(() => {
                const alert = saveIndicator.querySelector('.alert');
                if (alert) {
                    alert.remove();
                }
            }, 3000);
        }
        
        function markUnsaved() {
            hasUnsavedChanges = true;
            saveBtn.innerHTML = '<i class="bi bi-save me-2"></i>Kaydet *';
            saveBtn.classList.remove('btn-success');
            saveBtn.classList.add('btn-warning');
            
            // Auto-save after 2 seconds of inactivity
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(saveDocument, 2000);
        }
        
        function markSaved() {
            hasUnsavedChanges = false;
            saveBtn.innerHTML = '<i class="bi bi-check me-2"></i>Kaydedildi';
            saveBtn.classList.remove('btn-warning');
            saveBtn.classList.add('btn-success');
            
            setTimeout(() => {
                if (!hasUnsavedChanges) {
                    saveBtn.innerHTML = '<i class="bi bi-save me-2"></i>Kaydet';
                }
            }, 2000);
        }
        
        async function saveDocument() {
            try {
                saveBtn.disabled = true;
                saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Kaydediliyor...';
                
                const response = await fetch(`/save/${jsonFilename}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(documentData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    markSaved();
                    showSaveIndicator(result.message, 'success');
                } else {
                    showSaveIndicator(result.message, 'danger');
                }
            } catch (error) {
                console.error('Save error:', error);
                showSaveIndicator('Kaydetme sırasında hata oluştu', 'danger');
            } finally {
                saveBtn.disabled = false;
            }
        }
        
        // Event listeners for editing
        document.addEventListener('input', function(e) {
            if (e.target.classList.contains('editable')) {
                const field = e.target.dataset.field;
                const content = e.target.textContent || e.target.innerText;
                
                if (field === 'title') {
                    documentData.mevzuat_basligi = content;
                } else if (field === 'article-title') {
                    const articleIndex = parseInt(e.target.dataset.articleIndex);
                    documentData.maddeler[articleIndex].madde_numarasi = content;
                } else if (field === 'paragraph') {
                    const articleIndex = parseInt(e.target.dataset.articleIndex);
                    const paragraphIndex = parseInt(e.target.dataset.paragraphIndex);
                    documentData.maddeler[articleIndex].fikralar[paragraphIndex] = content;
                }
                
                markUnsaved();
            }
        });
        
        // Manual save button
        saveBtn.addEventListener('click', saveDocument);
        
        // Back button functionality
        backBtn.addEventListener('click', function() {
            if (hasUnsavedChanges) {
                if (confirm('Kaydedilmemiş değişiklikler var. Çıkmak istediğinize emin misiniz?')) {
                    window.history.back();
                }
            } else {
                window.history.back();
            }
        });
        
        // PDF debugging and setup
        console.log('Document data:', documentData);
        console.log('Metadata:', documentData._metadata);
        if (documentData._metadata) {
            console.log('File type:', documentData._metadata.file_type);
            console.log('Original filename:', documentData._metadata.original_filename);
        }
        
        // PDF viewer toggle functionality
        const togglePdfBtn = document.getElementById('togglePdfBtn');
        const pdfPanel = document.querySelector('.pdf-panel');
        const editPanel = document.getElementById('editPanel');
        let pdfVisible = false;
        let pdfLoaded = false;
        
        // PDF.js setup and handling
        let pdfDoc = null;
        let pageNum = 1;
        let pageCount = 0;
        let scale = 1.0;
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        
        if (togglePdfBtn && documentData._metadata && documentData._metadata.file_type === 'pdf') {
            togglePdfBtn.addEventListener('click', function() {
                if (!pdfVisible) {
                    showPdfViewer();
                } else {
                    hidePdfViewer();
                }
            });
        }
        
        function showPdfViewer() {
            pdfVisible = true;
            pdfPanel.classList.add('show');
            editPanel.classList.remove('full-width');
            togglePdfBtn.innerHTML = '<i class="bi bi-x-lg me-2"></i>PDF Gizle';
            togglePdfBtn.classList.remove('btn-info');
            togglePdfBtn.classList.add('btn-warning');
            
            if (!pdfLoaded) {
                loadPdf();
            }
        }
        
        function hidePdfViewer() {
            pdfVisible = false;
            pdfPanel.classList.remove('show');
            editPanel.classList.add('full-width');
            togglePdfBtn.innerHTML = '<i class="bi bi-file-pdf me-2"></i>PDF Görüntüle';
            togglePdfBtn.classList.remove('btn-warning');
            togglePdfBtn.classList.add('btn-info');
        }
        
        function loadPdf() {
            if (pdfLoaded) return;
            
            // PDF viewer elements
            const pdfCanvas = document.getElementById('pdfCanvas');
            const loadingIndicator = document.getElementById('pdfLoadingIndicator');
            const pageInfo = document.getElementById('pageInfo');
            const prevPageBtn = document.getElementById('prevPage');
            const nextPageBtn = document.getElementById('nextPage');
            const zoomInBtn = document.getElementById('zoomIn');
            const zoomOutBtn = document.getElementById('zoomOut');
            const zoomLevel = document.getElementById('zoomLevel');
            const openPdfBtn = document.getElementById('openPdfNewTab');
            
            // Configure PDF.js worker
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
            
            // Load the PDF
            const pdfUrl = `/view-pdf/${jsonFilename}`;
            console.log('Loading PDF from:', pdfUrl);
            
            pdfjsLib.getDocument(pdfUrl).promise.then(function(pdf) {
                console.log('PDF loaded successfully');
                pdfDoc = pdf;
                pageCount = pdf.numPages;
                pdfLoaded = true;
                
                // Clear loading indicator and add canvas container
                if (loadingIndicator) {
                    pdfCanvas.removeChild(loadingIndicator);
                }
                
                // Create container for canvas and text layer
                const pageContainer = document.createElement('div');
                pageContainer.style.position = 'relative';
                pageContainer.style.margin = '0 auto';
                pageContainer.style.border = '1px solid #dee2e6';
                pageContainer.style.backgroundColor = 'white';
                
                // Add canvas to container
                canvas.style.display = 'block';
                canvas.style.position = 'relative';
                pageContainer.appendChild(canvas);
                
                // Create text layer div
                const textLayerDiv = document.createElement('div');
                textLayerDiv.className = 'textLayer';
                textLayerDiv.style.position = 'absolute';
                textLayerDiv.style.left = '0';
                textLayerDiv.style.top = '0';
                textLayerDiv.style.right = '0';
                textLayerDiv.style.bottom = '0';
                textLayerDiv.style.overflow = 'hidden';
                textLayerDiv.style.opacity = '0.2';
                textLayerDiv.style.lineHeight = '1.0';
                pageContainer.appendChild(textLayerDiv);
                
                pdfCanvas.appendChild(pageContainer);
                
                // Render first page
                renderPage(pageNum);
                
                // Update UI
                updatePageInfo();
                updateZoomLevel();
                
            }).catch(function(error) {
                console.error('Error loading PDF:', error);
                if (loadingIndicator) {
                    loadingIndicator.innerHTML = `
                        <div class="text-center">
                            <i class="bi bi-exclamation-triangle display-4 mb-3 text-danger"></i>
                            <h5>PDF Yüklenemedi</h5>
                            <p>PDF dosyası yüklenirken bir hata oluştu.</p>
                            <button class="btn btn-primary" onclick="window.open('/view-pdf/${jsonFilename}', '_blank')">
                                <i class="bi bi-box-arrow-up-right me-2"></i>
                                Yeni Sekmede Aç
                            </button>
                        </div>
                    `;
                }
            });
            
            // PDF control functions
            function renderPage(num) {
                if (!pdfDoc) return;
                
                pdfDoc.getPage(num).then(function(page) {
                    const viewport = page.getViewport({scale: scale});
                    canvas.height = viewport.height;
                    canvas.width = viewport.width;
                    
                    // Update container size
                    const pageContainer = canvas.parentElement;
                    pageContainer.style.width = viewport.width + 'px';
                    pageContainer.style.height = viewport.height + 'px';
                    
                    const renderContext = {
                        canvasContext: ctx,
                        viewport: viewport
                    };
                    
                    // Render the PDF page
                    page.render(renderContext).promise.then(function() {
                        console.log('Page rendered successfully');
                        
                        // Render text layer for text selection
                        return page.getTextContent();
                    }).then(function(textContent) {
                        // Clear previous text layer
                        const textLayerDiv = pageContainer.querySelector('.textLayer');
                        textLayerDiv.innerHTML = '';
                        textLayerDiv.style.width = viewport.width + 'px';
                        textLayerDiv.style.height = viewport.height + 'px';
                        
                        // Render text layer
                        pdfjsLib.renderTextLayer({
                            textContent: textContent,
                            container: textLayerDiv,
                            viewport: viewport,
                            textDivs: []
                        });
                        
                        console.log('Text layer rendered for selection');
                    }).catch(function(error) {
                        console.warn('Text layer rendering failed:', error);
                    });
                });
            }
            
            function updatePageInfo() {
                if (pageInfo) {
                    pageInfo.textContent = `Sayfa: ${pageNum} / ${pageCount}`;
                }
                if (prevPageBtn) {
                    prevPageBtn.disabled = pageNum <= 1;
                }
                if (nextPageBtn) {
                    nextPageBtn.disabled = pageNum >= pageCount;
                }
            }
            
            function updateZoomLevel() {
                if (zoomLevel) {
                    zoomLevel.textContent = `${Math.round(scale * 100)}%`;
                }
            }
            
            // Event listeners
            if (prevPageBtn) {
                prevPageBtn.addEventListener('click', function() {
                    if (pageNum <= 1) return;
                    pageNum--;
                    renderPage(pageNum);
                    updatePageInfo();
                });
            }
            
            if (nextPageBtn) {
                nextPageBtn.addEventListener('click', function() {
                    if (pageNum >= pageCount) return;
                    pageNum++;
                    renderPage(pageNum);
                    updatePageInfo();
                });
            }
            
            if (zoomInBtn) {
                zoomInBtn.addEventListener('click', function() {
                    scale += 0.2;
                    renderPage(pageNum);
                    updateZoomLevel();
                });
            }
            
            if (zoomOutBtn) {
                zoomOutBtn.addEventListener('click', function() {
                    if (scale <= 0.4) return;
                    scale -= 0.2;
                    renderPage(pageNum);
                    updateZoomLevel();
                });
            }
            
            if (openPdfBtn) {
                openPdfBtn.addEventListener('click', function() {
                    window.open(`/view-pdf/${jsonFilename}`, '_blank');
                });
            }
        }
        
        // Add new article
        document.getElementById('addArticleBtn').addEventListener('click', function() {
            const newArticle = {
                madde_numarasi: `Madde ${documentData.maddeler.length + 1}`,
                fikralar: ["Yeni fıkra metni..."]
            };
            
            documentData.maddeler.push(newArticle);
            renderArticles();
            markUnsaved();
        });
        
        // Add new paragraph
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('add-paragraph-btn') || e.target.closest('.add-paragraph-btn')) {
                const btn = e.target.classList.contains('add-paragraph-btn') ? e.target : e.target.closest('.add-paragraph-btn');
                const articleIndex = parseInt(btn.dataset.articleIndex);
                
                documentData.maddeler[articleIndex].fikralar.push("Yeni fıkra metni...");
                renderArticles();
                markUnsaved();
            }
        });
        
        // Delete confirmation
        let deleteAction = null;
        
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('delete-article-btn') || e.target.closest('.delete-article-btn')) {
                const btn = e.target.classList.contains('delete-article-btn') ? e.target : e.target.closest('.delete-article-btn');
                const articleIndex = parseInt(btn.dataset.articleIndex);
                
                document.getElementById('deleteMessage').textContent = 
                    `"${documentData.maddeler[articleIndex].madde_numarasi}" maddesini silmek istediğinize emin misiniz?`;
                
                deleteAction = () => {
                    documentData.maddeler.splice(articleIndex, 1);
                    renderArticles();
                    markUnsaved();
                };
                
                deleteModal.show();
            } else if (e.target.classList.contains('delete-paragraph-btn') || e.target.closest('.delete-paragraph-btn')) {
                const btn = e.target.classList.contains('delete-paragraph-btn') ? e.target : e.target.closest('.delete-paragraph-btn');
                const articleIndex = parseInt(btn.dataset.articleIndex);
                const paragraphIndex = parseInt(btn.dataset.paragraphIndex);
                
                document.getElementById('deleteMessage').textContent = 
                    'Bu fıkrayı silmek istediğinize emin misiniz?';
                
                deleteAction = () => {
                    documentData.maddeler[articleIndex].fikralar.splice(paragraphIndex, 1);
                    renderArticles();
                    markUnsaved();
                };
                
                deleteModal.show();
            }
        });
        
        document.getElementById('confirmDeleteBtn').addEventListener('click', function() {
            if (deleteAction) {
                deleteAction();
                deleteAction = null;
            }
            deleteModal.hide();
        });
        
        function renderArticles() {
            const container = document.getElementById('articlesContainer');
            container.innerHTML = '';
            
            documentData.maddeler.forEach((madde, articleIndex) => {
                const articleHtml = `
                    <div class="article-item" data-article-index="${articleIndex}">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <div class="d-flex align-items-center">
                                <i class="bi bi-grip-vertical drag-handle me-2"></i>
                                <h6 class="mb-0 editable" 
                                    contenteditable="true" 
                                    data-field="article-title"
                                    data-article-index="${articleIndex}">${madde.madde_numarasi}</h6>
                            </div>
                            <div class="action-buttons">
                                <button class="btn btn-outline-primary btn-sm me-2 add-paragraph-btn" 
                                        data-article-index="${articleIndex}">
                                    <i class="bi bi-plus me-1"></i>
                                    Fıkra Ekle
                                </button>
                                <button class="btn btn-outline-danger btn-sm delete-article-btn" 
                                        data-article-index="${articleIndex}">
                                    <i class="bi bi-trash me-1"></i>
                                    Sil
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="paragraphs-container" data-article-index="${articleIndex}">
                                ${madde.fikralar.map((fikra, paragraphIndex) => `
                                    <div class="paragraph-item" data-paragraph-index="${paragraphIndex}">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <div class="flex-grow-1">
                                                <i class="bi bi-grip-vertical drag-handle me-2"></i>
                                                <span class="badge bg-info me-2">${paragraphIndex + 1}</span>
                                                <div class="editable d-inline-block" 
                                                     contenteditable="true" 
                                                     data-field="paragraph"
                                                     data-article-index="${articleIndex}"
                                                     data-paragraph-index="${paragraphIndex}"
                                                     style="min-width: 200px;">${fikra}</div>
                                            </div>
                                            <div class="action-buttons ms-2">
                                                <button class="btn btn-outline-danger btn-sm delete-paragraph-btn" 
                                                        data-article-index="${articleIndex}"
                                                        data-paragraph-index="${paragraphIndex}">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', articleHtml);
            });
        }
        
        // Warn before leaving with unsaved changes
        window.addEventListener('beforeunload', function(e) {
            if (hasUnsavedChanges) {
                e.preventDefault();
                e.returnValue = '';
            }
        });
        
        // Initial focus on title for better UX
        document.getElementById('documentTitle').focus();
    </script>
</body>
</html>